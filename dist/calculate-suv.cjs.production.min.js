"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class e{constructor(e){this.fullDate=e}getTimeInSec(){const e=this.fullDate.substring(0,10),t=this.fullDate.substring(11,28),i=parseInt(e.substring(0,4),10),r=e.length>=7?parseInt(e.substring(5,7),10):void 0,n=e.length>=10?parseInt(e.substring(8,10),10):void 0;if(isNaN(i)||void 0!==r&&isNaN(r)||void 0!==n&&isNaN(n)||i>3e3||r&&(r<1||r>12)||n&&(n<1||n>31))throw new Error(`invalid date '${e}'`);const a=new Date(e+"T00:00:00.000000Z"),o=parseInt(t.substring(0,2),10),s=t.length>=5?parseInt(t.substring(3,5),10):void 0,c=t.length>=8?parseInt(t.substring(6,8),10):void 0,l=t.substring(9,15),u=l?parseInt(l,10)*Math.pow(10,-l.length):void 0;if(isNaN(o)||void 0!==s&&isNaN(s)||void 0!==c&&isNaN(c)||void 0!==u&&isNaN(u)||o<0||o>23||s&&(s<0||s>59)||c&&(c<0||c>59)||u&&(u<0||u>999999))throw new Error(`invalid time '${t}'`);let d=a.getTime()/1e3;return d+=3600*o,void 0!==s&&(d+=60*s),void 0!==c&&(d+=c),void 0!==u&&(d+=u),d}getTimeInMicroSec(){return 1e6*this.getTimeInSec()}}function t(t,i){const r=(""+(i.hours||"00")).padStart(2,"0"),n=(""+(i.minutes||"00")).padStart(2,"0"),a=(""+(i.seconds||"00")).padStart(2,"0"),o=(""+t.month).padStart(2,"0"),s=(""+t.day).padStart(2,"0"),c=(""+(i.fractionalSeconds||"000000")).padEnd(6,"0");return new e(`${t.year}-${o}-${s}T${r}:${n}:${a}.${c}Z`)}function i(e){if(!e||8!==e.length||"string"!=typeof e)throw new Error(`invalid DA '${e}'`);const t=parseInt(e.substring(0,4),10),i=parseInt(e.substring(4,6),10),r=parseInt(e.substring(6,8),10);if(1!=(n=r,a=i,o=t,!isNaN(o)&&a>0&&a<=12&&n>0&&n<=function(e,t){switch(e){case 2:return t%4==0&&t%100||t%400==0?29:28;case 9:case 4:case 6:case 11:return 30;default:return 31}}(a,o)))throw new Error(`invalid DA '${e}'`);var n,a,o;return{year:t,month:i,day:r}}function r(e){if(!e||e.length<2||"string"!=typeof e)throw new Error(`invalid TM '${e}'`);const t=parseInt(e.substring(0,2),10),i=e.length>=4?parseInt(e.substring(2,4),10):void 0,r=e.length>=6?parseInt(e.substring(4,6),10):void 0,n=e.length>=8?e.substring(7,13):void 0,a=n?parseInt(n,10)*Math.pow(10,6-n.length):void 0;if(isNaN(t)||void 0!==i&&isNaN(i)||void 0!==r&&isNaN(r)||void 0!==a&&isNaN(a)||t<0||t>23||i&&(i<0||i>59)||r&&(r<0||r>59)||a&&(a<0||a>999999))throw new Error(`invalid TM '${e}'`);return{hours:t,minutes:i,seconds:r,fractionalSeconds:a}}function n(e){return t(i(e.substring(0,8)),r(e.substring(8)))}exports.calculateSUVScalingFactors=function(a){const{CorrectedImage:o,Units:s,PhilipsPETPrivateGroup:c,PatientWeight:l,PatientSex:u,PatientSize:d}=a[0];if(!o.includes("ATTN")||!o.includes("DECY"))throw new Error('CorrectedImage must contain "ATTN" and "DECY": '+o);if(!a.every(e=>{return e.Units===s&&(t=e.CorrectedImage,i=o,Array.isArray(t)&&Array.isArray(i)&&t.length===i.length&&t.every((e,t)=>e===i[t]))&&e.PatientWeight===l&&e.PatientSex===u&&e.PatientSize===d&&e.RadionuclideHalfLife===a[0].RadionuclideHalfLife&&e.RadionuclideTotalDose===a[0].RadionuclideTotalDose&&e.DecayCorrection===a[0].DecayCorrection&&e.SeriesDate===a[0].SeriesDate&&e.SeriesTime===a[0].SeriesTime;var t,i}))throw new Error("The set of instances does not appear to come from one Series. Every instance must have identical values for series-level metadata properties");let v=new Array(a.length);v=function(a){const{RadionuclideTotalDose:o,RadionuclideHalfLife:s,RadiopharmaceuticalStartDateTime:c,RadiopharmaceuticalStartTime:l,SeriesDate:u}=a[0],d=function(a){const{SeriesDate:o,SeriesTime:s,GEPrivatePostInjectionDateTime:c}=a[0],l=new Array(a.length),u=t(i(o),r(s));let d=new e("3000-01-01T00:00:00.000000Z"),v=d.getTimeInSec();if(a.forEach(e=>{const{AcquisitionDate:n,AcquisitionTime:a}=e,o=t(i(n),r(a));d=d.getTimeInSec()>=v||o.getTimeInSec()<d.getTimeInSec()?o:d}),d.getTimeInSec()>=v)throw new Error("Earliest acquisition time or date could not be parsed.");return u.getTimeInSec()<=d.getTimeInSec()?l.fill(u):l.fill(c?n(c):d)}(a),v=function(e){const{RadiopharmaceuticalStartDateTime:a,RadiopharmaceuticalStartTime:o,SeriesDate:s}=e;let c,l;if(a)return n(a);if(o&&s)return c=r(o),l=i(s),t(l,c);throw new Error("Invalid input: "+e)}({RadiopharmaceuticalStartDateTime:c,RadiopharmaceuticalStartTime:l,SeriesDate:u});return a.map((e,t)=>{const i=d[t].getTimeInSec()-v.getTimeInSec();if(i<0)throw new Error("Decay time cannot be less than zero");return 1/(o*Math.pow(2,-i/s))})}(a);let h=new Array(a.length);const p=1e3*l;if("BQML"===s)h=v.map((function(e){return e*p}));else if("CNTS"===s){const e=a.every(e=>{var t,i;return e.PhilipsPETPrivateGroup&&void 0!==(null===(t=e.PhilipsPETPrivateGroup)||void 0===t?void 0:t.SUVScaleFactor)&&0!==(null===(i=e.PhilipsPETPrivateGroup)||void 0===i?void 0:i.SUVScaleFactor)}),t=a.every(e=>{var t,i,r;return e.PhilipsPETPrivateGroup&&!(null!==(t=e.PhilipsPETPrivateGroup)&&void 0!==t&&t.SUVScaleFactor)&&void 0!==(null===(i=e.PhilipsPETPrivateGroup)||void 0===i?void 0:i.ActivityConcentrationScaleFactor)&&0!==(null===(r=e.PhilipsPETPrivateGroup)||void 0===r?void 0:r.ActivityConcentrationScaleFactor)});if(e)h=a.map(e=>e.PhilipsPETPrivateGroup.SUVScaleFactor);else{if(!t)throw new Error("Units are in CNTS, but PhilipsPETPrivateGroup has invalid values: "+JSON.stringify(c));h=a.map((e,t)=>e.PhilipsPETPrivateGroup.ActivityConcentrationScaleFactor*v[t]*p)}}else{if("GML"!==s)throw new Error("Units has an invalid value: "+s);h.fill(1)}let S,g;return l&&d&&(S=function(e){const{PatientWeight:t,PatientSize:i}=e;return Math.pow(t,.425)*Math.pow(100*i,.725)*71.84}({PatientWeight:l,PatientSize:d})),l&&u&&d&&(g=function(e){const{PatientSex:t,PatientWeight:i,PatientSize:r}=e;let n;const a=i*i/(r*r*1e4);if("F"===t)n=1.07*i-120*a;else{if("M"!==t)throw new Error("PatientSex is an invalid value: "+t);n=1.1*i-148*a}return 1e3*n}({PatientWeight:l,PatientSex:u,PatientSize:d})),h.map((function(e,t){const i={suvbw:e};return S&&(i.suvbsa=v[t]*S),g&&(i.suvlbm=v[t]*g),i}))};
//# sourceMappingURL=calculate-suv.cjs.production.min.js.map
